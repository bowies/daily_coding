WITH SORT_EVT AS(
    SELECT
        EVENT_TYPE,
        VALUE,
    TIME,
    RANK() OVER (PARTITION BY EVENT_TYPE ORDER BY TIME DESC) RANK
FROM
    EVENTS
    )

SELECT
    ONE.EVENT_TYPE AS event_type, ONE.VALUE-TWO.VALUE AS value
FROM
    (SELECT * FROM SORT_EVT WHERE RANK = 1) ONE
    JOIN
    (SELECT * FROM SORT_EVT WHERE RANK = 2) TWO
ON
    ONE.EVENT_TYPE = TWO.EVENT_TYPE
ORDER BY
    ONE.EVENT_TYPE